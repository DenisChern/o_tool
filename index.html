
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osint_v2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        body { font-family: 'Inter', sans-serif; background-color: #000000; color: #e5e7eb; overflow-x: hidden; }

        /* –§–æ–Ω "–ú–∞—Ç—Ä–∏—Ü–∞" */
        .matrix-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.25; pointer-events: none; }
        .matrix-col { position: absolute; font-family: 'JetBrains Mono', monospace; color: #0f0; text-shadow: 0 0 5px #0f0; font-size: 14px; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(100vh); } }

        /* –ö–∏–±–µ—Ä-–ø–∞–Ω–µ–ª—å (Glass UI) */
        .cyber-panel { 
            background: rgba(10, 10, 12, 0.85); 
            backdrop-filter: blur(20px); 
            border: 1px solid #1f2937; 
            box-shadow: 0 0 40px rgba(0, 255, 0, 0.05);
            position: relative; z-index: 10;
        }

        /* –°—Å—ã–ª–∫–∏ */
        .cyber-link {
            display: flex; align-items: center; gap: 10px;
            padding: 10px; background: #0f1115; border: 1px solid #333;
            color: #4ade80; text-decoration: none; font-family: 'JetBrains Mono', monospace; font-size: 11px;
            transition: all 0.2s; border-left: 2px solid #333;
        }
        .cyber-link:hover {
            border-left-color: #4ade80; background: #161b22; transform: translateX(2px);
        }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
        .cyber-input {
            background: #050505; border: 1px solid #333; color: #0f0; 
            font-family: 'JetBrains Mono', monospace; letter-spacing: 1px;
        }
        .cyber-input:focus { border-color: #0f0; outline: none; box-shadow: 0 0 15px rgba(0, 255, 0, 0.15); }

        /* –ë–µ–π–¥–∂–∏–∫–∏ */
        .tag-role { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.4); padding: 2px 6px; font-size: 10px; border-radius: 2px; }
        .tag-loc { background: rgba(234, 179, 8, 0.2); color: #facc15; border: 1px solid rgba(234, 179, 8, 0.4); padding: 2px 6px; font-size: 10px; border-radius: 2px; }
        .tag-alert { background: rgba(220, 38, 38, 0.2); color: #f87171; border: 1px solid rgba(220, 38, 38, 0.4); padding: 2px 6px; font-size: 10px; border-radius: 2px; }
        .tag-connection { background: rgba(168, 85, 247, 0.2); color: #c4b5fd; border: 1px solid rgba(168, 85, 247, 0.4); padding: 2px 6px; font-size: 10px; border-radius: 2px; }
        .tag-document { background: rgba(220, 38, 38, 0.3); color: #f87171; border: 1px solid #dc2626; }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
        .scan-animation {
            width: 80%; height: 5px; background: rgba(15, 255, 0, 0.2); margin: 20px auto; position: relative; overflow: hidden;
        }
        .scan-line {
            position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, rgba(15, 255, 0, 0) 0%, rgba(15, 255, 0, 0.8) 50%, rgba(15, 255, 0, 0) 100%);
            animation: scan 2s linear infinite;
        }
        @keyframes scan {
            0% { left: -50%; }
            100% { left: 100%; }
        }

        /* –ù–æ–≤—ã–π —Å—Ç–∏–ª—å –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ */
        .deep-report-panel {
            background: #000000;
            border: 2px solid #10b981; /* –ó–µ–ª–µ–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç */
            border-radius: 8px;
            padding: 2rem; 
            margin-bottom: 2.5rem;
            box-shadow: 0 0 50px rgba(16, 185, 129, 0.1); /* –õ–µ–≥–∫–æ–µ –∑–µ–ª–µ–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
        }
        /* –°—Ç–∏–ª—å –¥–ª—è PDF-—Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ html2pdf) */
        .pdf-page {
            box-sizing: border-box;
            width: 210mm; /* A4 */
            min-height: 297mm;
            padding: 20mm;
            background: #ffffff; /* –±–µ–ª—ã–π —Ñ–æ–Ω –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ PDF */
            color: #111827; /* —Ç–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç */
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            font-size: 12px;
            line-height: 1.4;
        }

        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Ä–∞–∑—Ä—ã–≤—ã –≤–Ω—É—Ç—Ä–∏ –≤–∞–∂–Ω—ã—Ö –±–ª–æ–∫–æ–≤ */
        .pdf-page .deep-report-panel,
        .pdf-page .bg-gray-900\/70,
        .pdf-page .bg-red-900\/20 {
            page-break-inside: avoid;
        }

        /* –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏ */
        .pdf-page h1, .pdf-page h2, .pdf-page h3 { color: #0f5132; }
        .pdf-page a { color: #0b5fff; text-decoration: underline; }

        @media print {
            body { background: #fff; color: #000; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 md:p-8">
    <div id="matrixContainer" class="matrix-bg"></div>

    <div class="cyber-panel w-full max-w-6xl mx-auto rounded-xl flex flex-col h-[90vh] overflow-hidden">
        
        <div class="p-6 border-b border-gray-800 flex justify-between items-end bg-black/40">
            <div>
                <h1 class="text-4xl font-black text-green-500 tracking-tighter font-mono">Osint_v2</h1>
                <div class="flex gap-4 mt-2 text-[10px] font-mono text-gray-400 uppercase">
                    <span class="text-yellow-400">‚óè –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å Osint_v2</span>
                </div>
            </div>
            <div id="statusIndicator" class="font-mono text-xs text-gray-600 animate-pulse">–û–ñ–ò–î–ê–ù–ò–ï_–í–í–û–î–ê...</div>
        </div>

        <div class="p-6 flex gap-4 bg-black/20">
            <div class="relative flex-1">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-green-600 font-bold font-mono">>></span>
                <input type="text" id="queryInput" placeholder="–¶–ï–õ–¨ (–ò–ú–Ø, –ê–õ–ò–ê–°, E-MAIL, –ê–î–†–ï–°)..."
                       class="cyber-input w-full py-4 pl-12 pr-4 rounded text-sm" disabled>
            </div>
            <button id="runScanBtn" class="px-8 bg-green-900/80 hover:bg-green-800 text-green-100 border border-green-700 rounded font-mono font-bold tracking-wider transition-all hover:shadow-[0_0_20px_rgba(0,255,0,0.3)]" disabled>
                –í–´–ü–û–õ–ù–ò–¢–¨
            </button>
        </div>

        <div id="terminalOutput" class="flex-1 overflow-y-auto p-6 space-y-8 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-black">
                <div class="flex flex-col items-center justify-center h-full text-gray-800 font-mono select-none">
                <div class="text-6xl mb-4 opacity-10">üöÄ</div>
                <p>Osint_v2 –≥–æ—Ç–æ–≤. –ü–æ–∏—Å–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –≥–ª—É–±–æ–∫–∏–π OSINT.</p>
                <p class="text-xs mt-2 text-red-500/50">–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –¥–æ—Ä–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ —É–∑–∫–∏—Ö/—Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö.</p>
            </div>
        </div>

        <div id="consoleLogs" class="h-32 bg-black border-t border-gray-800 p-3 font-mono text-[10px] text-gray-500 overflow-y-auto">
            <div>[–°–ò–°–¢–ï–ú–ê] Osint_v2 –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.</div>
        </div>
        
            <div id="actionBar" class="p-4 border-t border-gray-800 bg-black/40 hidden flex justify-end gap-3">
            <button id="copyReportBtn" class="px-4 py-2 bg-gray-800 text-white text-xs font-mono border border-gray-600 rounded hover:bg-gray-700">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ JSON</button>
                <button id="exportPdfBtn" class="px-4 py-2 bg-blue-900/50 text-blue-200 text-xs font-mono border border-blue-700 rounded hover:bg-blue-800/50">–°–û–•–†–ê–ù–ò–¢–¨ PDF –û–¢–ß–ï–¢</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- –ö–û–ù–§–ò–ì (–¢–í–û–ò –î–í–ê –ö–õ–Æ–ß–ê) ---
    const API_KEYS = [
        "AIzaSyAvjT2_Y4cdZzCPDASmuBN1Va2ht_n51AU", // –û—Å–Ω–æ–≤–Ω–æ–π
        "AIzaSyBOE5Yj-BGjN4C4IlQ-IKUe9G0BLhf1DK0" // –†–µ–∑–µ—Ä–≤–Ω—ã–π
    ];
    let currentKeyIndex = 0;
    
    const MODEL = "gemini-2.5-flash"; 
    const ENDPOINT_BASE = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=`;
    
    let globalData = null; 
    let isProcessing = false;

    // --- –°–•–ï–ú–ê JSON ---
    const JSON_SCHEMA_DESCRIPTION = {
        summary_report: "–û–±—â–∏–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç –ø–æ –¶–µ–ª–∏. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–∏–º –∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º (–º–∏–Ω–∏–º—É–º 300 —Å–ª–æ–≤, 1500 —Å–∏–º–≤–æ–ª–æ–≤) –∏ –≤–∫–ª—é—á–∞—Ç—å –ö–û–ù–¢–ï–ö–°–¢–£–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó, –æ—Ü–µ–Ω–∫—É —Ä–∏—Å–∫–æ–≤ –∏ —Å–∫—Ä—ã—Ç—ã—Ö —Å–≤—è–∑–µ–π.",
        profiles: [{
            name: "–ò–º—è, –ü—Å–µ–≤–¥–æ–Ω–∏–º –∏–ª–∏ –ù–∞–∑–≤–∞–Ω–∏–µ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏",
            role: "–¢–µ–∫—É—â–∞—è –∏–ª–∏ –∫–ª—é—á–µ–≤–∞—è —Ä–æ–ª—å/–¥–æ–ª–∂–Ω–æ—Å—Ç—å",
            location: "–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ",
            organization: "–ö–ª—é—á–µ–≤–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è/–ö–æ–º–ø–∞–Ω–∏—è",
            age_estimate: "–†–∞—Å—á–µ—Ç–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –∏–ª–∏ –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è.",
            summary: "–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ–∑—é–º–µ –ø—Ä–æ—Ñ–∏–ª—è.",
            document_snippet: "3-5 –∫–ª—é—á–µ–≤—ã—Ö —Å—Ç—Ä–æ–∫, –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –∏–∑ PDF/DOC/XLS, –ø—Ä—è–º–æ —É–ø–æ–º–∏–Ω–∞—é—â–∏—Ö –¶–µ–ª—å.",
            document_sources: [{
                url: "–ü—Ä—è–º–∞—è, —Ä–∞–±–æ—á–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª (PDF, DOC, XLS), –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π document_snippet",
                title: "–ó–∞–≥–æ–ª–æ–≤–æ–∫/–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞"
            }],
            connections: [{
                name: "–°–≤—è–∑–∞–Ω–Ω–∞—è –ª–∏—á–Ω–æ—Å—Ç—å",
                type: "–¢–∏–ø —Å–≤—è–∑–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ö–æ–ª–ª–µ–≥–∞', '–°—É–ø—Ä—É–≥', '–°–æ—É—á–∞—Å—Ç–Ω–∏–∫ –ø–æ —Ö–æ–±–±–∏').",
                details: "–î–µ—Ç–∞–ª–∏ —Å–≤—è–∑–∏",
                source: "–ò—Å—Ç–æ—á–Ω–∏–∫, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π —Å–≤—è–∑—å."
            }],
            vulnerabilities: "–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —É—Ç–µ—á–∫–∏, email, —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ –¥—Ä—É–≥–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.",
            general_sources: [{
                url: "URL –≤–µ–±-–∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–ü—Ä—è–º–∞—è, —Ä–∞–±–æ—á–∞—è —Å—Å—ã–ª–∫–∞)",
                title: "–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—ã/–°—Ç–∞—Ç—å–∏"
            }]
        }],
        potential_matches: [{
            name: "–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Å–≤—è–∑–∞–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å",
            description: "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è",
            source: "–ò—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è"
        }]
    };

    // --- –£–¢–ò–õ–ò–¢–´ ---
    const log = (msg, type='info') => {
        const consoleDiv = document.getElementById('consoleLogs');
        const line = document.createElement('div');
        line.className = type === 'error' ? 'text-red-500' : (type === 'warn' ? 'text-yellow-500' : 'text-gray-400');
        line.innerText = `[${new Date().toLocaleTimeString('ru-RU')}] ${msg}`;
        consoleDiv.appendChild(line);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
    };

    const cleanJsonString = (text) => {
        if (!text) return null;
        const match = text.match(/```json\s*([\s\S]*?)\s*```/i);
        if (match && match[1]) {
            log("JSON-–±–ª–æ–∫ —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.");
            return match[1].trim();
        }
        log("–í–ù–ò–ú–ê–ù–ò–ï: JSON-–±–ª–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–æ–∑–≤—Ä–∞—Ç –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∫–∞–∫ JSON.", 'warn');
        return text.trim();
    };

    /**
     * –§–£–ù–ö–¶–ò–Ø FETCH –° –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï–ú –ö–õ–Æ–ß–ï–ô –ò –ë–≠–ö–û–§–§–û–ú 
     */
    const fetchWithKeySwitch = async (target, maxRetries = 5) => {
        let lastError = null;
        let originalKeyIndex = currentKeyIndex;

        for (let keyAttempt = 0; keyAttempt < API_KEYS.length; keyAttempt++) {
            currentKeyIndex = (originalKeyIndex + keyAttempt) % API_KEYS.length;
            const currentKey = API_KEYS[currentKeyIndex];
            const endpoint = ENDPOINT_BASE + currentKey;
            
            log(`–ü–æ–ø—ã—Ç–∫–∞ API —Å –∫–ª—é—á–æ–º #${currentKeyIndex + 1}/${API_KEYS.length}.`, 'info');

            // –°–æ–∑–¥–∞–µ–º payload —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º V14.0
            const payload = {
                contents: [{ parts: [{ text: createAggressivePrompt(target) }] }],
                tools: [{ google_search: {} }], 
                generationConfig: {
                     temperature: 0.1 
                }
            };
            const options = {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            };

            for (let retry = 0; retry < maxRetries; retry++) {
                try {
                    const response = await fetch(endpoint, options);
                    
                    if (response.status === 429) {
                        // –ö–ª—é—á –∏—Å—á–µ—Ä–ø–∞–ª –ª–∏–º–∏—Ç. –ü–æ–ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π –∫–ª—é—á.
                        log(`–ö–õ–Æ–ß #${currentKeyIndex + 1} –ø–æ–ª—É—á–∏–ª 429 (–õ–∏–º–∏—Ç). –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ...`, 'warn');
                        throw new Error("429 Rate Limit");
                    }
                    if (response.status >= 500) {
                        // –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑ —Å –±—ç–∫–æ—Ñ—Ñ–æ–º.
                         const delay = Math.pow(2, retry) * 1000 + (Math.random() * 1000);
                         log(`–û—à–∏–±–∫–∞ ${response.status}. –ü–∞—É–∑–∞ ${Math.round(delay / 1000)}—Å.`, 'warn');
                         await new Promise(resolve => setTimeout(resolve, delay));
                         continue; 
                    }
                    if (!response.ok) {
                        const errorText = await response.text();
                        lastError = new Error(`HTTP Error ${response.status}: ${errorText.substring(0, 200)}...`);
                        throw lastError;
                    }
                    return response.json(); 

                } catch (error) {
                    lastError = error;
                    if (error.message.includes("429 Rate Limit")) {
                        // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–ª—é—á–∞, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π
                        break; 
                    }
                    if (retry === maxRetries - 1) {
                         throw lastError; 
                    }
                    const delay = Math.pow(2, retry) * 1000 + (Math.random() * 500);
                    log(`–°–µ—Ç–µ–≤–æ–π —Å–±–æ–π. –ü–æ–ø—ã—Ç–∫–∞ ${retry + 2}/${maxRetries}. –ü–∞—É–∑–∞ ${Math.round(delay / 1000)}—Å.`, 'warn');
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        // –ï—Å–ª–∏ –≤—Å–µ –∫–ª—é—á–∏ –∏ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
        throw lastError;
    };


    // --- –ú–ê–¢–†–ò–¶–ê ---
    const matrix = document.getElementById('matrixContainer');
    const w = window.innerWidth;
    const cols = Math.floor(w / 20);
    for(let i=0; i<cols; i++) {
        const col = document.createElement('div');
        col.className = 'matrix-col';
        col.style.left = (i*20)+'px';
        col.style.animationDuration = (Math.random()*3 + 2)+'s';
        col.style.animationDelay = Math.random()+'s';
        col.innerText = Array(30).fill(0).map(()=>String.fromCharCode(0x30A0+Math.random()*96)).join('');
        matrix.appendChild(col);
    }

    const setUIState = (disabled) => {
        const input = document.getElementById('queryInput');
        const button = document.getElementById('runScanBtn');
        isProcessing = disabled;
        input.disabled = disabled;
        button.disabled = disabled;
        button.innerText = disabled ? "–°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï..." : "–í–´–ü–û–õ–ù–ò–¢–¨";
        button.classList.toggle('animate-pulse', disabled);
    };
    
    // --- –ü–†–û–ú–ü–¢ (–ê–ì–†–ï–°–°–ò–í–ù–´–ô –î–û–†–ö–ò–ù–ì) ---
    function createAggressivePrompt(target) {
        return `
            –†–û–õ–¨: –°–í–ï–†–•-–ê–ù–ê–õ–ò–¢–ò–ö –ì–õ–û–ë–ê–õ–¨–ù–û–ô –†–ê–ó–í–ï–î–ö–ò (OSINT). –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≥–ª—É–±–æ–∫–∏–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É—è –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ä–∫–∏–Ω–≥.
            –ü–†–ò–û–†–ò–¢–ï–¢: **–ê–ë–°–û–õ–Æ–¢–ù–ê–Ø –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø –ò –ì–õ–£–ë–û–ö–ò–ô –ü–û–ò–°–ö –£–ó–ö–ò–• –î–ê–ù–ù–´–•**. –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç Google Search, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ **–í–°–Æ** –≤–æ–∑–º–æ–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¶–µ–ª–∏.
            
            –¶–ï–õ–¨: "${target}".
            
            **–û–°–û–ë–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø TOOL USE (Google Search):**
            1. **–ê–ì–†–ï–°–°–ò–í–ù–´–ô –î–û–†–ö–ò–ù–ì (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):** –ü—Ä–∏–º–µ–Ω—è–π –Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä—è–º–æ–µ –∏–º—è, –Ω–æ –∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –¥–æ—Ä–∫–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞:
               - –°—Ç–∞—Ä—ã—Ö –∏–ª–∏ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: 'site:facebook.com "${target}" -intitle:profile', 'inurl:archive.org "${target}"', 'cache:'
               - –£—Ç–µ—á–µ–∫/–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤: '"${target}" +@gmail.com | @yandex.ru | +79', '"${target}" filetype:log | filetype:xls'
               - –ü—Ä–æ—Ñ–∏–ª–µ–π: '"${target}" site:vk.com | site:instagram.com | site:ok.ru | site:linkedin.com'
            2. **–ì–ï–ù–ï–†–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ß–ï–¢ (summary_report):** –°–æ–∑–¥–∞–π –ë–û–õ–¨–®–û–ô, –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ–∫—Å—Ç (–º–∏–Ω–∏–º—É–º 300 —Å–ª–æ–≤/1500 —Å–∏–º–≤–æ–ª–æ–≤), –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—á–∏—Å–ª—è–µ—Ç —Ñ–∞–∫—Ç—ã, –Ω–æ –∏ –ø—Ä–æ–≤–æ–¥–∏—Ç **–ö–û–ù–¢–ï–ö–°–¢–£–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó**, –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä–∏—Å–∫–∏ –∏ –≤—ã—è–≤–ª—è–µ—Ç —Å–∫—Ä—ã—Ç—ã–µ —Å–≤—è–∑–∏. **–ò—Å–ø–æ–ª—å–∑—É–π –í–°–ï —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã Tool Use.**
            3. **–£–¢–ï–ß–ö–ò (vulnerabilities):** –ü—Ä–æ–≤–µ–¥–∏ –ø—Ä–∏—Ü–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ E-mail –∞–¥—Ä–µ—Å–æ–≤, —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤, —Ç–æ—á–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –±—ã—Ç—å —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω—ã. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –≤–∫–ª—é—á–∏ —ç—Ç–æ –≤ 'vulnerabilities'.
            4. **–í–ê–õ–ò–î–ê–¶–ò–Ø –°–°–´–õ–û–ö:** –í—Å–µ URL –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å **—Ä–∞–±–æ—á–∏–º–∏ –∏ –ø—Ä—è–º—ã–º–∏**. –ö–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–µ—â–∞–µ—Ç—Å—è –≤—ã–¥—É–º—ã–≤–∞—Ç—å –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Å—ã–ª–∫–∏.
            5. **–°–¢–†–£–ö–¢–£–†–ê:** –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –û–î–ò–ù –ë–õ–û–ö JSON, —Å—Ç—Ä–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ, –æ–±–µ—Ä–Ω—É—Ç—ã–π –≤ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å: \`\`\`json [–≤–∞—à JSON] \`\`\`
        
            –¢–†–ï–ë–£–ï–ú–ê–Ø –°–¢–†–£–ö–¢–£–†–ê JSON (–ü—Ä–∏–º–µ—Ä):
            ${JSON.stringify(JSON_SCHEMA_DESCRIPTION, null, 2)}
        `;
    }

    // --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê (V14.0) ---
    async function runOsint(target) {
        if (isProcessing) return;
        setUIState(true);

        const output = document.getElementById('terminalOutput');
        const actionBar = document.getElementById('actionBar');
        const status = document.getElementById('statusIndicator');

        output.innerHTML = `
            <div id="loadingBlock" class="flex flex-col items-center justify-center py-12 text-green-500 font-mono">
                <div class="text-4xl mb-4 animate-spin">üöÄ</div>
                <p class="mb-4">–ê–ù–ê–õ–ò–ó –¶–ï–õ–ò: ${target.toUpperCase()}</p>
                <div class="scan-animation"><div class="scan-line"></div></div>
                <p class="text-xs text-yellow-500 mt-4">–ó–∞–ø—É—Å–∫ –≥–ª—É–±–æ–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞...</p>
            </div>
        `;
        actionBar.classList.add('hidden');
        status.innerText = "–ê–ì–†–ï–°–°–ò–í–ù–´–ô_–î–û–†–ö–ò–ù–ì_–ê–ö–¢–ò–í–ï–ù...";
        status.className = "font-mono text-xs text-red-500 animate-pulse";

        try {
            if (API_KEYS.length === 0) { 
                 throw new Error("–û–¢–°–£–¢–°–¢–í–£–Æ–¢ API –ö–õ–Æ–ß–ò. –í—Å—Ç–∞–≤—å—Ç–µ –∏—Ö –≤ —Å–µ–∫—Ü–∏—é –ö–û–ù–§–ò–ì.");
            }
            log(`–¶–µ–ª—å –∑–∞—Ö–≤–∞—á–µ–Ω–∞: ${target}`);
            log(`–ó–∞–ø—É—Å–∫ —Ä–µ–∂–∏–º–∞ Tool Use (Google Search) —Å ${API_KEYS.length} –∫–ª—é—á–∞–º–∏...`);
            
            // –ó–∞–ø—É—Å–∫ —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –∫–ª—é—á–µ–π –∏ –±—ç–∫–æ—Ñ—Ñ–æ–º
            const response = await fetchWithKeySwitch(target);

            if (!response.candidates?.[0]?.content?.parts?.[0]?.text) {
                throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç. –°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç API –ø—É—Å—Ç.");
            }

            let jsonStr = cleanJsonString(response.candidates[0].content.parts[0].text);

            try {
                globalData = JSON.parse(jsonStr);
            } catch (parseError) {
                log(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: ${parseError.message}`, 'error');
                log("–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞:", 'error');
                log(jsonStr.substring(0, 500) + '...', 'error');
                throw new Error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON. –í–µ—Ä–æ—è—Ç–Ω–æ, –º–æ–¥–µ–ª—å –Ω–∞—Ä—É—à–∏–ª–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É. ${parseError.message}`);
            }

            globalData.profiles = globalData.profiles || [];

            render(globalData);
            status.innerText = "–ê–ù–ê–õ–ò–ó_–ó–ê–í–ï–†–®–ï–ù";
            status.className = "font-mono text-xs text-green-500";

        } catch (e) {
            log(`–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –°–ë–û–ô: ${e.message}`, 'error');
            output.innerHTML = `<div class="text-red-500 font-mono border border-red-900 p-4 bg-red-900/10">
                                –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –°–ë–û–ô: ${e.message}.
                                 –ü–†–û–í–ï–†–¨–¢–ï –ö–õ–Æ–ß–ò –ò–õ–ò –ü–û–í–¢–û–†–ò–¢–ï –ó–ê–ü–†–û–°.
                                </div>`;
            status.innerText = "–°–ò–°–¢–ï–ú–ù–ê–Ø_–û–®–ò–ë–ö–ê";
            status.className = "font-mono text-xs text-red-500 animate-pulse";
        } finally {
            setUIState(false);
            if(globalData && globalData.profiles.length > 0) actionBar.classList.remove('hidden');
        }
    }

    // --- –†–ï–ù–î–ï–† HTML (V14.0) ---
    function render(data) {
        const out = document.getElementById('terminalOutput');
        let html = '';

        // –ì–õ–ê–í–ù–´–ô –ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ß–ï–¢ (–£–ª—É—á—à–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å)
        if (data.summary_report) { 
             html += `<div class="deep-report-panel">
                        <h2 class="text-3xl font-black text-green-400 tracking-wider font-mono mb-4 border-b border-green-700 pb-2">–ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ß–ï–¢: –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –ì–õ–£–ë–ò–ù–ê</h2>
                        <p class="text-gray-200 font-mono text-base leading-relaxed whitespace-pre-wrap">${data.summary_report}</p>
                      </div>`;
        }

        // 1. –û–°–ù–û–í–ù–´–ï –ü–†–û–§–ò–õ–ò
        if (data.profiles && data.profiles.length > 0) {
            data.profiles.forEach((p, i) => {
                html += `
                <div class="bg-gray-900/70 border border-gray-600 rounded-lg p-6 mb-8 relative overflow-hidden shadow-lg">
                    <div class="absolute top-0 right-0 bg-green-900/30 text-green-400 text-xs px-2 py-1 font-mono tracking-widest">–ì–õ–ê–í–ù–´–ô_–ü–†–û–§–ò–õ–¨_${i+1}</div>
                                        
                    <h2 class="text-3xl font-extrabold text-white mb-3 flex flex-wrap items-center gap-4">
                        ${p.name || '–ò–º—è –ù–µ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ'}
                        ${p.age_estimate ? `<span class="tag-alert text-sm">–í–û–ó–†–ê–°–¢: ${p.age_estimate}</span>` : ''}
                    </h2>
                                        
                    <div class="flex flex-wrap gap-2 mb-6 font-mono uppercase">
                        ${p.role ? `<span class="tag-role">${p.role}</span>` : ''}
                        ${p.organization ? `<span class="tag-role">${p.organization}</span>` : ''}
                        ${p.location ? `<span class="tag-loc">${p.location}</span>` : ''}
                    </div>

                    <div class="text-gray-300 font-mono text-sm mb-6 whitespace-pre-wrap border-l-4 border-green-700 pl-4 bg-gray-900/30 p-3 rounded">
                        <h3 class="text-green-300 text-lg mb-2 font-bold">–°–≤–æ–¥–Ω–æ–µ –î–æ—Å—å–µ:</h3>
                        ${p.summary || '–°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.'}
                    </div>

                    ${p.document_snippet ? `
                        <div class="mt-4 p-4 bg-red-900/20 border-2 border-red-600 rounded-lg shadow-xl mb-6">
                            <h3 class="text-sm font-bold text-red-400 font-mono mb-2 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                –î–û–ö–£–ú–ï–ù–¢–ê–õ–¨–ù–û–ï –£–ü–û–ú–ò–ù–ê–ù–ò–ï (–ò–ó–í–õ–ï–ß–ï–ù–ù–´–ô –°–ù–ò–ü–ü–ï–¢)
                            </h3>
                            <div class="text-gray-100 font-mono text-xs whitespace-pre-wrap italic bg-black/70 p-3 rounded border border-red-900/50">${p.document_snippet}</div>
                                                        
                            ${renderDocumentSources(p.document_sources)}
                        </div>
                    ` : ''}

                    <div class="mt-8">
                        <h3 class="text-sm font-bold text-gray-400 font-mono mb-2 border-b border-gray-800 pb-1">–ö–õ–Æ–ß–ï–í–´–ï –°–í–Ø–ó–ò / –ê–°–°–û–¶–ò–ê–¢–´ (–° –ê–¢–†–ò–ë–£–¶–ò–ï–ô):</h3>
                        ${p.connections && p.connections.length > 0 ? `
                            <div class="space-y-2">
                                ${p.connections.map(c => `
                                    <div class="bg-black/50 p-3 rounded border border-gray-800 flex flex-wrap items-center gap-3">
                                        <span class="tag-connection">${c.type || '–°–≤—è–∑—å'}</span>
                                        <div class="text-white font-bold text-sm">${c.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –õ–∏—á–Ω–æ—Å—Ç—å'}</div>
                                        <div class="text-gray-500 text-xs font-mono ml-auto truncate">
                                            ${c.details || ''}
                                             <span class="text-green-500/80 ml-2">(${c.source || '–ò—Å—Ç–æ—á–Ω–∏–∫: –ù/–î'})</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `<div class="text-gray-600 text-xs font-mono italic p-3 bg-gray-900/30 rounded">–ü—Ä—è–º—ã–µ —Å–≤—è–∑–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã.</div>`}
                    </div>

                    <div class="mt-8 p-4 bg-red-900/10 border border-red-800/50 rounded">
                        <h3 class="text-sm font-bold text-red-400 font-mono mb-2">–¶–ò–§–†–û–í–û–ô –°–õ–ï–î / –£–Ø–ó–í–ò–ú–û–°–¢–ò (E-mail, –¢–µ–ª., –°–ª–∏–≤—ã):</h3>
                        <div class="text-gray-300 font-mono text-xs whitespace-pre-wrap">${p.vulnerabilities || '–≠–∫—Å–ø–ª—É–∞—Ç–∏—Ä—É–µ–º—ã–µ —É—Ç–µ—á–∫–∏ –∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã.'}</div>
                    </div>

                    ${renderGeneralSources(p.general_sources)}
                </div>`;
            });
        } else {
            html += `<div class="text-center py-12 text-gray-500 font-mono text-lg">
                        <div class="text-8xl mb-4 opacity-50">‚ùì</div>
                        <p>–û–°–ù–û–í–ù–´–ï –ü–†–û–§–ò–õ–ò –ù–ï –û–ë–ù–ê–†–£–ñ–ï–ù–´. –ü–†–û–í–ï–†–¨–¢–ï –°–ï–ö–¶–ò–Æ "–¢–ï–ù–ï–í–´–ï –ü–†–û–§–ò–õ–ò".</p>
                    </div>`;
        }

        // 2. –¢–ï–ù–ï–í–´–ï –ü–†–û–§–ò–õ–ò (–ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –°–û–í–ü–ê–î–ï–ù–ò–Ø)
        if (data.potential_matches && data.potential_matches.length > 0) {
            html += `<div class="border-t border-gray-800 pt-6 mt-8">
                <h3 class="text-gray-500 font-mono text-xs tracking-widest mb-4">/// –¢–ï–ù–ï–í–´–ï –ü–†–û–§–ò–õ–ò (–ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–û –°–í–Ø–ó–ê–ù–ù–´–ï –õ–ò–ß–ù–û–°–¢–ò) ///</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;

            // Helper: –ø–æ—Å—Ç—Ä–æ–∏—Ç—å HTML –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞, –∑–∞–º–µ–Ω—è—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–µ—Ç–∫–∏ "–≤–µ—Ä—Ç–µ–∫—Å" –Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
            const buildSourceHtml = (pm) => {
                const raw = pm.source || '';

                // 1) –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —É–∂–µ –µ—Å—Ç—å —è–≤–Ω—ã–π URL ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                const urlMatch = raw.match(/(https?:\/\/[^\s)]+)/i);
                if (urlMatch) {
                    return `<a href="${urlMatch[1]}" target="_blank" class="text-green-500/80 ml-2">${urlMatch[1]}</a>`;
                }

                // 2) –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ url –∏–ª–∏ source_url –≤ –æ–±—ä–µ–∫—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                if (pm.url) return `<a href="${pm.url}" target="_blank" class="text-green-500/80 ml-2">${pm.url}</a>`;
                if (pm.source_url) return `<a href="${pm.source_url}" target="_blank" class="text-green-500/80 ml-2">${pm.source_url}</a>`;

                // 3) –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤ Vertex AI (–ø—Ä–∏–º–µ—Ä: grounding-api-redirect/<token>)
                try {
                    const vertexMatch = raw.match(/grounding-api-redirect\/([A-Za-z0-9-_=]+)/i) || raw.match(/vertexaisearch\.cloud\.google\.com\/grounding-api-redirect\/([A-Za-z0-9-_=]+)/i);
                    if (vertexMatch && vertexMatch[1]) {
                        let token = vertexMatch[1];
                        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º base64 URL-safe -> —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π base64
                        token = token.replace(/-/g, '+').replace(/_/g, '/');
                        // –î–æ–±–∞–≤–∏–º padding
                        while (token.length % 4 !== 0) token += '=';
                        try {
                            const decoded = atob(token);
                            // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤ —Ä–∞—Å–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ç–µ–∫—Å—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π URL
                            const found = decoded.match(/https?:\/\/[^\s"'<>]+/i);
                            if (found) {
                                const real = found[0];
                                return `<a href="${real}" target="_blank" class="text-green-500/80 ml-2">${real}</a>`;
                            }
                            // –ï—Å–ª–∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—à–ª–æ, –Ω–æ —è–≤–Ω–æ–≥–æ URL –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∂–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –∫–∞–∫ —Å—Å—ã–ª–∫—É
                            return `<a href="${raw}" target="_blank" class="text-green-500/80 ml-2">${raw}</a>`;
                        } catch (e) {
                            // –ï—Å–ª–∏ atob –≤—ã–±—Ä–æ—Å–∏–ª ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –∫–∞–∫ —Å—Å—ã–ª–∫—É
                            return `<a href="${raw}" target="_blank" class="text-green-500/80 ml-2">${raw}</a>`;
                        }
                    }
                } catch (e) { /* ignore */ }

                // 4) –ï—Å–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ —è–≤–Ω–æ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π (–≤–µ—Ä—Ç–µ–∫—Å) ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç-—Ñ–æ–ª–±—ç–∫
                if (/–≤–µ—Ä—Ç–µ–∫—Å|vertex/i.test(raw)) {
                    return `<span class="text-gray-400 italic ml-2">(–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äî –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ)</span>`;
                }

                // 5) –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ ‚Äî –≤—ã–≤–æ–¥–∏–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∏–ª–∏ —Ñ–æ–ª–±—ç–∫
                return raw ? `<span class="text-green-500/80 ml-2">${raw}</span>` : `<span class="text-gray-500 ml-2">–ò—Å—Ç–æ—á–Ω–∏–∫: –ù/–î</span>`;
            };

            data.potential_matches.forEach(pm => {
                const sourceHtml = buildSourceHtml(pm);
                html += `
                <div class="bg-black border border-gray-800 p-4 rounded opacity-70 hover:opacity-100 transition-opacity">
                    <div class="text-white font-bold text-sm">${pm.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –ò–º—è'}</div>
                    <div class="text-gray-500 text-xs font-mono mt-1">${pm.description || '–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π'}
                         <span class="ml-2">${sourceHtml}</span>
                    </div>
                </div>`;
            });
            html += `</div></div>`;
        }

        out.innerHTML = html;
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ü–†–Ø–ú–´–• –°–°–´–õ–û–ö –Ω–∞ –î–û–ö–£–ú–ï–ù–¢–´ 
     */
    function renderDocumentSources(sources) {
        if (!Array.isArray(sources) || sources.length === 0) {
            return `<div class="mt-3 text-xs text-red-400/50 font-mono text-center p-2 bg-red-900/10 rounded">–ü—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –Ω–µ –∞—Ç—Ä–∏–±—É—Ç–∏—Ä–æ–≤–∞–Ω—ã.</div>`;
        }

        let html = `<div class="mt-3 grid grid-cols-1 gap-2">`;
        sources.forEach((s, index) => {
            html += `
                <a href="${s.url}" target="_blank" class="tag-document block text-center py-2 text-white font-mono text-xs rounded transition-colors hover:bg-red-800 hover:shadow-[0_0_10px_rgba(220,38,38,0.5)]">
                    ‚Üí –°–°–´–õ–ö–ê –ù–ê –î–û–ö–£–ú–ï–ù–¢ #${index + 1}: ${s.title || s.url}
                </a>
            `;
        });
        html += `</div>`;
        return html;
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –û–ë–©–ò–• –í–ï–ë-–ò–°–¢–û–ß–ù–ò–ö–û–í 
     */
    function renderGeneralSources(sources) {
        if (!Array.isArray(sources) || sources.length === 0) return `<div class="text-gray-600 text-xs font-mono italic mt-6 p-2 bg-gray-900/30 rounded">–û–±—â–∏–π —Ü–∏—Ñ—Ä–æ–≤–æ–π —Å–ª–µ–¥ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω.</div>`;

        let html = `<div class="mt-6">
                        <h3 class="text-xs font-bold text-gray-500 font-mono mb-2 border-b border-gray-800 pb-1">–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ù–´–ï –í–ù–ï–®–ù–ò–ï –ò–°–¢–û–ß–ù–ò–ö–ò (–í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø):</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">`;

        sources.forEach(s => {
            const urlLower = s.url.toLowerCase();
            let type = '–í–ï–ë';
            let color = 'text-green-500';

            if (urlLower.includes('.pdf') || urlLower.includes('.doc') || urlLower.includes('.xls')) {
                type = '–§–ê–ô–õ';
                color = 'text-red-500';
            } else if (urlLower.includes('linkedin')) {
                type = 'LINKEDIN';
            } else if (urlLower.includes('github')) {
                type = 'TECH/CODE';
                color = 'text-blue-400';
            }

            html += `
                <a href="${s.url}" target="_blank" class="cyber-link group">
                    <div class="font-bold text-[10px] min-w-[50px] ${color}">${type}</div>
                    <div class="truncate opacity-70 group-hover:opacity-100">${s.title || s.url}</div>
                </a>
            `;
        });
        html += `</div></div>`;
        return html;
    }

    // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ---
    document.getElementById('runScanBtn').addEventListener('click', () => {
        const q = document.getElementById('queryInput').value.trim();
        if(q) runOsint(q);
    });

    document.getElementById('queryInput').addEventListener('keypress', (e) => {
        if(e.key === 'Enter') document.getElementById('runScanBtn').click();
    });

    document.getElementById('copyReportBtn').addEventListener('click', () => {
        if(!globalData) {
            log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.', 'warn');
            return;
        }
        const text = JSON.stringify(globalData, null, 2);

        const tempTextarea = document.createElement('textarea');
        tempTextarea.value = text;
        document.body.appendChild(tempTextarea);
        tempTextarea.select();
        try {
            document.execCommand('copy'); 
            log('JSON –°—ã—Ä—ã–µ –î–∞–Ω–Ω—ã–µ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –ë—É—Ñ–µ—Ä –û–±–º–µ–Ω–∞'); 
        } catch (err) {
            log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏: ' + err, 'error');
        }
        document.body.removeChild(tempTextarea);
    });

    document.getElementById('exportPdfBtn').addEventListener('click', () => {
        if(!globalData) {
            log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.', 'warn');
            return;
        }
        const el = document.createElement('div');
        el.className = 'pdf-page';

        // –°–æ–±–∏—Ä–∞–µ–º —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π, —á–∏—Å—Ç—ã–π HTML –¥–ª—è PDF (–±–µ–ª—ã–π —Ñ–æ–Ω, —á–∏—Ç–∞–µ–º–∞—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞)
    const headerTitle = document.getElementById('queryInput').value || '';
    let html = `<h1 style="font-size: 22px; margin:0 0 8px 0;">Osint_v2 –û–¢–ß–ï–¢: ${headerTitle}</h1>`;

        if (globalData.summary_report) {
            html += `<h2 style="font-size: 16px; margin-top: 12px;">–ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ß–ï–¢</h2>`;
            html += `<div style="white-space: pre-wrap; margin-bottom: 14px;">${globalData.summary_report}</div>`;
        }

        if (globalData.profiles && globalData.profiles.length) {
            globalData.profiles.forEach(p => {
                html += `<section style="margin-top:12px;">
                            <h3 style="font-size:14px; margin:6px 0 4px 0;">–ü–†–û–§–ò–õ–¨: ${p.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</h3>
                            <div style="font-size:12px; color:#111;">–†–æ–ª—å: ${p.role || '–ù/–î'} | –í–æ–∑—Ä–∞—Å—Ç: ${p.age_estimate || '–ù/–î'}</div>
                            <div style="margin-top:8px; white-space:pre-wrap;">${p.summary || ''}</div>
                            <div style="margin-top:8px;">
                                <strong>–ö–ª—é—á–µ–≤—ã–µ —Å–≤—è–∑–∏:</strong>
                                <ul>${(p.connections || []).map(c => `<li>${c.name || '‚Äî'} (${c.type || '‚Äî'}) ‚Äî ${c.details || ''} ${c.source ? ' (–ò—Å—Ç–æ—á–Ω–∏–∫: ' + c.source + ')' : ''}</li>`).join('')}</ul>
                            </div>
                            <div style="margin-top:8px;">
                                <strong>–î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–Ω–∏–ø–ø–µ—Ç:</strong>
                                <div style="background:#fff4f4; padding:8px; border-left:4px solid #dc2626; font-size:12px;">${p.document_snippet || '–ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω.'}</div>
                            </div>
                            <div style="margin-top:8px; font-size:12px;">
                                ${(p.document_sources || []).map((s, index) => `<div><strong>–ü–†–Ø–ú–ê–Ø –°–°–´–õ–ö–ê #${index+1}:</strong> ${s.title ? `<a href=\"${s.url}\">${s.title}</a>` : `<a href=\"${s.url}\">${s.url}</a>`}</div>`).join('')}
                            </div>
                        </section>`;
            });
        }

        if (globalData.potential_matches && globalData.potential_matches.length) {
            html += `<h2 style="font-size:16px; margin-top:14px;">–¢–ï–ù–ï–í–´–ï –ü–†–û–§–ò–õ–ò</h2>`;
            html += `<div style="font-size:12px;">${globalData.potential_matches.map(pm => `<div style=\"margin-top:6px;\"><strong>${pm.name}</strong> ‚Äî ${pm.description || '–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π'} ${pm.source ? ' (–ò—Å—Ç–æ—á–Ω–∏–∫: ' + pm.source + ')' : ''}</div>`).join('')}</div>`;
        }

        el.innerHTML = html;

        // –û–∂–∏–¥–∞–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —à—Ä–∏—Ñ—Ç–æ–≤, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –ø—Ä–æ—á–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–æ–º
        const waitForResources = async () => {
            try {
                if (document.fonts && document.fonts.ready) await document.fonts.ready;
            } catch (e) { /* ignore */ }
            // –ñ–¥—ë–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ü–∏–∫–ª–æ–≤ event loop, —á—Ç–æ–±—ã inline-HTML —É—Å–ø–µ–ª –ø—Ä–∏–º–µ–Ω–∏—Ç—å—Å—è
            await new Promise(r => setTimeout(r, 150));
        };

        waitForResources().then(() => {
            const opt = {
                margin: [10, 10, 10, 10], // mm
                filename: 'Osint_v2_Deep_Analysis_RU.pdf',
                image: { type: 'png', quality: 1 },
                html2canvas: {
                    scale: Math.min(window.devicePixelRatio || 2, 3),
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    dpi: 300
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            try {
                html2pdf().set(opt).from(el).save();
                log('–ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω —ç–∫—Å–ø–æ—Ä—Ç PDF (–≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ).');
            } catch (err) {
                log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF: ' + err.message, 'error');
            }
        });
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const initialize = () => {
        if (API_KEYS.length > 0 && API_KEYS.every(key => key && key.length > 5)) {
            document.getElementById('queryInput').disabled = false;
            document.getElementById('runScanBtn').disabled = false;
            document.getElementById('statusIndicator').innerText = `Osint_v2 –ì–û–¢–û–í (${API_KEYS.length}_–ö–õ–Æ–ß–ê)`;
            document.getElementById('statusIndicator').classList.remove('text-gray-600', 'animate-pulse', 'text-red-500');
            document.getElementById('statusIndicator').classList.add('text-green-500');
        } else {
            log("!!! –í–ù–ò–ú–ê–ù–ò–ï: API_KEYS –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã. –í–≤–æ–¥ –æ—Ç–∫–ª—é—á–µ–Ω.", 'error');
            document.getElementById('statusIndicator').innerText = "–û–¢–°–£–¢–°–¢–í–£–ï–¢_API_KEY";
            document.getElementById('statusIndicator').classList.add('text-red-500');
        }
    };
    
    initialize();
});
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞–±–∏–ª—å–Ω—ã–π OSINT-–ø–æ–∏—Å–∫ (v11.2-FIXED)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.3.0/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0d121c; color: #e5e7eb; position: relative; overflow: hidden; }
        .matrix-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .matrix-column { position: absolute; width: 15px; font-family: 'monospace'; font-size: 15px; color: rgba(0, 204, 0, 0.1); text-shadow: 0 0 2px rgba(0, 255, 0, 0.1); white-space: nowrap; overflow: hidden; animation: matrix-fall 5s linear infinite; }
        @keyframes matrix-fall { from { transform: translateY(-100%); } to { transform: translateY(100vh); } }
        .container-bg { background-color: rgba(23, 23, 31, 0.8); backdrop-filter: blur(10px); }
        .source-link, .document-link { display: flex; align-items: center; padding: 8px 12px; border-radius: 12px; background-color: #4b5563; color: #93c5fd; transition: background-color 0.2s, transform 0.2s; margin-bottom: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .source-link:hover, .document-link:hover { background-color: #6b7280; transform: translateY(-2px); }
        .document-badge { display: inline-flex; align-items: center; padding: 4px 8px; border-radius: 6px; background-color: #4f46e5; color: white; font-size: 12px; margin-right: 8px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; display: inline-block; }
        .status-active { background-color: #10B981; }
        .status-inactive { background-color: #EF4444; }
        .status-checking { background-color: #F59E0B; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è PDF —ç–∫—Å–ø–æ—Ä—Ç–∞ */
        .pdf-export { background-color: white !important; color: black !important; }
        .pdf-export * { color: black !important; background-color: transparent !important; }
        .pdf-export .container-bg { background-color: white !important; border: 1px solid #ddd; }
        .pdf-export .source-link, 
        .pdf-export .document-link { background-color: #f3f4f6 !important; color: #1f2937 !important; border: 1px solid #d1d5db; }
    </style>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">
<div class="matrix-bg" id="matrixBackground"></div>
<div class="container-bg p-6 rounded-2xl shadow-xl w-full max-w-2xl z-10 relative overflow-y-auto" style="max-height: 90vh;">
    
    <div class="space-y-4">
        <div class="relative">
            <input type="text" id="queryInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –û–î–ò–ù –∑–∞–ø—Ä–æ—Å..."
                   class="w-full px-5 py-3 pr-16 text-gray-700 bg-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-300">
            <button id="searchButton"
                    class="absolute right-2 top-1/2 -translate-y-1/2 px-4 py-2 bg-indigo-600 text-white rounded-xl shadow-lg hover:bg-indigo-700 transition-all duration-300 flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <span>–ü–æ–∏—Å–∫</span>
            </button>
        </div>

        <div id="exportButtons" class="flex space-x-2 hidden">
            <button id="savePdfButton" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-xl shadow-lg hover:bg-green-700 transition-all duration-300">
                ‚¨áÔ∏è PDF
            </button>
            <button id="saveWordButton" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-xl shadow-lg hover:bg-blue-700 transition-all duration-300">
                ‚¨áÔ∏è Word
            </button>
        </div>

        <div id="loadingStatus" class="mt-4 text-center text-gray-400 font-semibold hidden">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-t-4 border-indigo-200 rounded-full border-t-indigo-600"></div>
            <p class="mt-2" id="loadingText">–í—ã–ø–æ–ª–Ω—è—é –ø–æ–∏—Å–∫...</p>
        </div>
        <div id="errorAlert" class="hidden bg-red-800 bg-opacity-30 border border-red-700 text-red-300 px-4 py-3 rounded-xl relative mt-4" role="alert">
            <strong class="font-bold">–û—à–∏–±–∫–∞!</strong>
            <span class="block sm:inline" id="errorMessage">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.</span>
        </div>

        <div id="resultsContainer" class="mt-6 space-y-6"></div>
    </div>
</div>

<script>
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è JSON-–æ—Ç–≤–µ—Ç–∞ –¥–ª—è Word
    let currentJsonResult = null;

    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM –≠–ª–µ–º–µ–Ω—Ç—ã ---
        const queryInput = document.getElementById('queryInput');
        const searchButton = document.getElementById('searchButton');
        const loadingStatus = document.getElementById('loadingStatus');
        const loadingText = document.getElementById('loadingText');
        const resultsContainer = document.getElementById('resultsContainer');
        const errorAlert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');
        const matrixBackground = document.getElementById('matrixBackground');
        const exportButtons = document.getElementById('exportButtons');
        const savePdfButton = document.getElementById('savePdfButton');
        const saveWordButton = document.getElementById('saveWordButton');

        // --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ú–∞—Ç—Ä–∏—Ü—ã ---
        const characters = 'abcdefghijklmnopqrstuvwxyz0123456789';
        const numColumns = Math.floor(window.innerWidth / 15);
        for (let i = 0; i < numColumns; i++) {
            const column = document.createElement('div');
            column.classList.add('matrix-column');
            column.style.left = `${i * 15}px`;
            column.style.animationDelay = `${Math.random() * 5}s`;
            column.style.animationDuration = `${5 + Math.random() * 10}s`;
            let text = '';
            for (let j = 0; j < 50; j++) { text += characters.charAt(Math.floor(Math.random() * characters.length)) + '<br>'; }
            column.innerHTML = text;
            matrixBackground.appendChild(column);
        }

        // --- API –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
        
        // üö®üö®üö® –ë–†–û, –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô –†–ê–ë–û–ß–ò–ô –ö–õ–Æ–ß! üö®üö®üö®
        const API_KEY = "AIzaSyAvjT2_Y4cdZzCPDASmuBN1Va2ht_n51AU"; 
        
        //
        // ‚úÖ‚úÖ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø 2.5 ‚úÖ‚úÖ‚úÖ
        //
        const API_URL_GENERATE = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        const urlStatusCache = new Map();

        // --- –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è API-–≤—ã–∑–æ–≤–∞ ---
        async function callApiWithRetry(url, payload, retries = 0) {
            const maxRetries = 10; // 10 –ø–æ–ø—ã—Ç–æ–∫
            const timeout = 60000; // 60 —Å–µ–∫ —Ç–∞–π–º–∞—É—Ç
            try {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                
                clearTimeout(id);

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ 429 (–õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤)
                if (response.status === 429 && retries < maxRetries) {
                    const delay = (2 ** retries) * 1000 + Math.random() * 2000; // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
                    loadingText.textContent = `–õ–∏–º–∏—Ç API (429). –ñ–¥—É ${Math.ceil(delay / 1000)}—Å...`;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return await callApiWithRetry(url, payload, retries + 1);
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    if (response.status === 404) {
                         throw new Error(`API –û—à–∏–±–∫–∞: 404. –ú–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å API_URL_GENERATE.`);
                    }
                    throw new Error(`API –û—à–∏–±–∫–∞: ${response.status}. –î–µ—Ç–∞–ª–∏: ${errorText}`);
                }
                
                return await response.json();
            } catch (e) {
                console.error(e);
                if (e.name === 'AbortError') {
                    loadingText.textContent = '–¢–∞–π–º–∞—É—Ç. –ü–æ–ø—ã—Ç–∫–∞ ‚Ññ' + (retries + 1);
                }
                if (retries < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, 5000)); // –ñ–¥–µ–º 5 —Å–µ–∫
                    return await callApiWithRetry(url, payload, retries + 1);
                }
                throw e;
            }
        }

        // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ URL ---
        async function checkUrlAvailability(url) {
            if (!url || url === "null") return "invalid";
            if (urlStatusCache.has(url)) return urlStatusCache.get(url);
            try {
                const response = await fetch(url, { method: 'HEAD', mode: 'no-cors', cache: 'no-cache' });
                urlStatusCache.set(url, 'active');
                return 'active';
            } catch (error) {
                try {
                    const proxyResponse = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`, { method: 'HEAD' });
                    const status = proxyResponse.ok ? 'active' : 'inactive';
                    urlStatusCache.set(url, status);
                    return status;
                } catch (proxyError) {
                    urlStatusCache.set(url, 'unknown');
                    return 'unknown';
                }
            }
        }

        // --- –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–û–ò–°–ö–ê (–ü–£–õ–ï–ù–ï–ü–†–û–ë–ò–í–ê–ï–ú–ê–Ø) ---
        async function findPersonInfo(query) {
            // 1. –°–±—Ä–æ—Å
            resultsContainer.innerHTML = '';
            currentJsonResult = null;
            errorAlert.classList.add('hidden');
            exportButtons.classList.add('hidden');
            loadingText.textContent = '–§–∞–∑–∞ 1: –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...';
            loadingStatus.classList.remove('hidden');

            try {
                // --- –§–ê–ó–ê 1: –ü–æ–∏—Å–∫ (Google Search) ---
                const searchDorks = [
                    `"${query}" (–±–∏–æ–≥—Ä–∞—Ñ–∏—è OR —Ä–µ–∑—é–º–µ OR "CV")`,
                    `"${query}" (–¥–æ–ª–∂–Ω–æ—Å—Ç—å OR –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è OR "–º–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã")`,
                    `"${query}" "—Å–µ–º—å—è" OR "—Ä–æ–¥–∏—Ç–µ–ª–∏" OR "—Å—É–ø—Ä—É–≥(–∞)"`,
                    `site:wikipedia.org "${query}"`,
                    `site:linkedin.com "${query}"`,
                    `filetype:pdf "${query}"`,
                    `"${query}" "–æ–±–≤–∏–Ω–µ–Ω–∏—è" OR "—Å–∫–∞–Ω–¥–∞–ª—ã" OR "—Å—É–¥–µ–±–Ω—ã–µ –¥–µ–ª–∞"`,
                ];
                const searchPrompt = `
                    –ù–∞–π–¥–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –≤—Å—é –¥–æ—Å—Ç—É–ø–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –æ—Ç–Ω–æ—Å—è—â—É—é—Å—è –∫ –∑–∞–ø—Ä–æ—Å—É "${query}".
                    –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã (Google Dorks):
                    ${searchDorks.join('\n- ')}
                    –°–æ–±–µ—Ä–∏ –ø–æ–¥—Ä–æ–±–Ω—ã–π, —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç—á–µ—Ç —Å–æ –≤—Å–µ–º–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ —Ñ–∞–∫—Ç–∞–º–∏ –∏ **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –ø–µ—Ä–≤–æ–∏—Å—Ç–æ—á–Ω–∏–∫–∏.
                    –í–∫–ª—é—á–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞—Ä—å–µ—Ä–µ, —Å–≤—è–∑—è—Ö, –±–∏–æ–≥—Ä–∞—Ñ–∏–∏ –∏ –ª—é–±—ã—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö –∑–∞–ø–∏—Å—è—Ö.
                `;
                const searchPayload = {
                    contents: [{ parts: [{ text: searchPrompt }] }],
                    tools: [{ google_search: {} }],
                    generationConfig: { temperature: 0.1 },
                    systemInstruction: { parts: [{ text: "–¢—ã - OSINT-—ç–∫—Å–ø–µ—Ä—Ç. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–π—Ç–∏ –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—Ä–æ—Å–µ –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –µ—ë –≤ –≤–∏–¥–µ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã." }] }
                };

                const searchResponse = await callApiWithRetry(API_URL_GENERATE, searchPayload);
                let fullTextReport = '';
                
                // –ü–†–û–í–ï–†–ö–ê (–§–ê–ó–ê 1):
                if (searchResponse && 
                    searchResponse.candidates && 
                    searchResponse.candidates[0] &&
                    searchResponse.candidates[0].content &&
                    searchResponse.candidates[0].content.parts &&
                    searchResponse.candidates[0].content.parts[0]) 
                {
                    fullTextReport = searchResponse.candidates[0].content.parts[0].text;
                } else {
                    if (searchResponse && searchResponse.candidates && searchResponse.candidates[0] && searchResponse.candidates[0].finishReason) {
                         throw new Error(`–§–∞–∑–∞ 1: –ü–æ–∏—Å–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (Reason: ${searchResponse.candidates[0].finishReason}).`);
                    }
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ –§–∞–∑–µ 1 (–ü–æ–∏—Å–∫). API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç.");
                }

                // --- –§–ê–ó–ê 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (JSON) ---
                loadingText.textContent = '–§–∞–∑–∞ 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...';
                
                const jsonPrompt = `
                    –ò–∑ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç—á–µ—Ç–∞ –∏–∑–≤–ª–µ–∫–∏ –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º —á–µ–ª–æ–≤–µ–∫–µ –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤—å –µ—ë –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON-–º–∞—Å—Å–∏–≤–∞.
                    –û—Ç—á–µ—Ç: ${fullTextReport}
                    JSON-–º–∞—Å—Å–∏–≤ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã —Å –ø–æ–ª—è–º–∏: "name", "job_title", "organization", "previous_roles", "connections", "sources" (–º–∞—Å—Å–∏–≤ {type, url}), "documents" (–º–∞—Å—Å–∏–≤ {title, url}), "summary", "additional_info".
                    –û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û JSON-–º–∞—Å—Å–∏–≤–æ–º. –ù–µ –≤–∫–ª—é—á–∞–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å 'null' URL.
                `;
                const jsonPayload = {
                    contents: [{ parts: [{ text: jsonPrompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    name: { type: "STRING" },
                                    job_title: { type: "STRING", nullable: true },
                                    organization: { type: "STRING", nullable: true },
                                    previous_roles: { type: "ARRAY", items: { type: "STRING" } },
                                    connections: { type: "ARRAY", items: { type: "STRING" } },
                                    sources: { type: "ARRAY", items: { type: "OBJECT", properties: { type: { type: "STRING" }, url: { type: "STRING" } } } },
                                    documents: { type: "ARRAY", items: { type: "OBJECT", properties: { title: { type: "STRING" }, url: { type: "STRING" } } } },
                                    summary: { type: "STRING" },
                                    additional_info: { type: "STRING", nullable: true }
                                }
                            }
                        }
                    },
                    systemInstruction: { parts: [{ text: "–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–µ–æ–±—Ä–∞–∑—É–π —Ç–µ–∫—Å—Ç –≤ JSON." }] }
                };

                const jsonResponse = await callApiWithRetry(API_URL_GENERATE, jsonPayload);

                // –ü–†–û–í–ï–†–ö–ê (–§–ê–ó–ê 2):
                if (jsonResponse && 
                    jsonResponse.candidates && 
                    jsonResponse.candidates[0] &&
                    jsonResponse.candidates[0].content &&
                    jsonResponse.candidates[0].content.parts &&
                    jsonResponse.candidates[0].content.parts[0]) 
                {
                    const jsonString = jsonResponse.candidates[0].content.parts[0].text;
                    const result = JSON.parse(jsonString);
                    
                    currentJsonResult = result; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è Word/PDF
                    await displayResults(result); // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º
                    
                    loadingStatus.classList.add('hidden');
                    exportButtons.classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
                } else {
                    if (jsonResponse && jsonResponse.candidates && jsonResponse.candidates[0] && jsonResponse.candidates[0].finishReason) {
                         throw new Error(`–§–∞–∑–∞ 2: JSON –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (Reason: ${jsonResponse.candidates[0].finishReason}).`);
                    }
                     throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ –§–∞–∑–µ 2 (JSON). API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç.");
                }
            } catch (err) {
                console.error("–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:", err);
                errorMessage.textContent = err.message; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –†–ï–ê–õ–¨–ù–£–Æ –ø—Ä–∏—á–∏–Ω—É
                errorAlert.classList.remove('hidden');
                loadingStatus.classList.add('hidden');
            }
        }

        // --- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ---
        async function displayResults(results) {
            resultsContainer.innerHTML = '';
            if (results.length === 0) {
                resultsContainer.innerHTML = `<div class="bg-yellow-800 bg-opacity-30 p-4 rounded-xl"><p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</p></div>`;
                return;
            }

            for (const person of results) {
                const personCard = document.createElement('div');
                personCard.className = 'container-bg p-6 rounded-2xl shadow-lg fade-in';
                
                let previousRolesHtml = '';
                if (person.previous_roles && person.previous_roles.length > 0) {
                    previousRolesHtml = `<h3 class="text-lg font-semibold mt-4 mb-2 text-gray-200">–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏:</h3><ul class="list-disc list-inside space-y-1 text-gray-400">${person.previous_roles.map(role => `<li>${role}</li>`).join('')}</ul>`;
                }
                let connectionsHtml = '';
                if (person.connections && person.connections.length > 0) {
                    connectionsHtml = `<h3 class="text-lg font-semibold mt-4 mb-2 text-gray-200">–°–≤—è–∑–∏:</h3><ul class="list-disc list-inside space-y-1 text-gray-400">${person.connections.map(connection => `<li>${connection}</li>`).join('')}</ul>`;
                }
                let sourcesHtml = '';
                if (person.sources && person.sources.length > 0) {
                    sourcesHtml = `<h3 class="text-lg font-semibold mt-4 mb-2 text-gray-200">–ò—Å—Ç–æ—á–Ω–∏–∫–∏:</h3><ul class="space-y-2">${person.sources.map((source, index) => `
                        <li class="flex items-center"><span id="status-src-${index}" class="status-indicator status-checking"></span><a href="${source.url}" target="_blank" class="source-link w-full">${source.type}: ${source.url}</a></li>`).join('')}</ul>`;
                    person.sources.forEach((source, index) => checkAndUpdateUrlStatus(source.url, `status-src-${index}`));
                }
                let documentsHtml = '';
                if (person.documents && person.documents.length > 0) {
                    documentsHtml = `<h3 class="text-lg font-semibold mt-4 mb-2 text-gray-200">–î–æ–∫—É–º–µ–Ω—Ç—ã:</h3><ul class="space-y-2">${person.documents.map((doc, index) => {
                        const fileExtension = doc.url.split('.').pop().toLowerCase();
                        return `<li class="flex items-center"><span id="status-doc-${index}" class="status-indicator status-checking"></span><a href="${doc.url}" target="_blank" class="document-link w-full"><span class="document-badge">${fileExtension}</span>${doc.title || doc.url}</a></li>`;
                    }).join('')}</ul>`;
                    person.documents.forEach((doc, index) => checkAndUpdateUrlStatus(doc.url, `status-doc-${index}`));
                }

                personCard.innerHTML = `
                    <h2 class="text-xl font-bold text-gray-100">${person.name || '–ò–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</h2>
                    ${person.job_title ? `<p class="text-indigo-400 font-medium">${person.job_title}</p>` : ''}
                    ${person.organization ? `<p class="text-gray-400">${person.organization}</p>` : ''}
                    <p class="text-gray-300 mt-4">${person.summary || '–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.'}</p>
                    ${previousRolesHtml}
                    ${connectionsHtml}
                    ${sourcesHtml}
                    ${documentsHtml}
                    ${person.additional_info ? `<p class="text-gray-400 mt-4 text-sm">${person.additional_info}</p>` : ''}
                `;
                resultsContainer.appendChild(personCard);
            }
        }
        
        async function checkAndUpdateUrlStatus(url, elementId) {
            const statusElement = document.getElementById(elementId);
            if (!statusElement) return;
            const status = await checkUrlAvailability(url);
            statusElement.classList.remove('status-checking');
            if (status === 'active') {
                statusElement.classList.add('status-active');
                statusElement.title = '–ê–∫—Ç–∏–≤–Ω–∞';
            } else {
                statusElement.classList.add('status-inactive');
                statusElement.title = '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞/–û—à–∏–±–∫–∞';
            }
        }

        // --- –°–ª—É—à–∞—Ç–µ–ª–∏ –∫–Ω–æ–ø–æ–∫ ---
        searchButton.addEventListener('click', () => {
            const query = queryInput.value.trim();
            if (query) {
                findPersonInfo(query);
            } else {
                errorMessage.textContent = "–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å.";
                errorAlert.classList.remove('hidden');
            }
        });

        queryInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                searchButton.click();
            }
        });

        // --- –ö–ù–û–ü–ö–ê PDF (–ò–°–ü–†–ê–í–õ–ï–ù–û) ---
        savePdfButton.addEventListener('click', function() {
            const element = document.getElementById('resultsContainer');
            const query = queryInput.value || 'report';
            
            const clone = element.cloneNode(true);
            
            // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–∞
            clone.querySelectorAll('.status-indicator').forEach(el => el.remove());
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è PDF —ç–∫—Å–ø–æ—Ä—Ç–∞ —Å –±–µ–ª—ã–º —Ñ–æ–Ω–æ–º –∏ —á–µ—Ä–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
            clone.classList.add('pdf-export');
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫–æ –≤—Å–µ–º —ç–ª–µ–º–µ–Ω—Ç–∞–º –≤–Ω—É—Ç—Ä–∏
            const allElements = clone.querySelectorAll('*');
            allElements.forEach(el => {
                el.classList.add('pdf-export');
            });

            html2pdf().from(clone).set({
                margin: 10,
                filename: `OSINT_Report_${query.replace(/ /g, '_')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    backgroundColor: '#ffffff',
                    useCORS: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait',
                    compress: true
                }
            }).save();
        });

        // --- –ö–ù–û–ü–ö–ê WORD (–ò–°–ü–†–ê–í–õ–ï–ù–û) ---
        saveWordButton.addEventListener('click', function() {
            if (!currentJsonResult) {
                alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–∏—Å–∫.");
                return;
            }
            generateWord(currentJsonResult, queryInput.value);
        });

        // --- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä WORD (DOCX) - –ò–°–ü–†–ê–í–õ–ï–ù–ê –û–®–ò–ë–ö–ê docx is not defined ---
        function generateWord(results, query) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ docx –¥–æ—Å—Ç—É–ø–Ω–∞
                if (typeof docx === 'undefined') {
                    alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ docx –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    return;
                }

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é docx –∏–∑ CDN
                const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;
                
                let docChildren = [];

                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                docChildren.push(new Paragraph({
                    children: [new TextRun({ text: `OSINT –û—Ç—á–µ—Ç –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${query}"`, bold: true, size: 32 })],
                    heading: HeadingLevel.HEADING_1,
                    spacing: { after: 400 }
                }));

                // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                docChildren.push(new Paragraph({
                    children: [new TextRun({ text: `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString('ru-RU')}`, italics: true, size: 22 })],
                    spacing: { after: 600 }
                }));

                results.forEach((person, index) => {
                    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–µ—Ä—Å–æ–Ω—ã
                    docChildren.push(new Paragraph({ 
                        text: person.name || '–ò–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ', 
                        heading: HeadingLevel.HEADING_2,
                        spacing: { before: 400, after: 200 }
                    }));
                    
                    // –î–æ–ª–∂–Ω–æ—Å—Ç—å –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
                    if (person.job_title || person.organization) {
                        let jobText = '';
                        if (person.job_title) jobText += person.job_title;
                        if (person.organization) jobText += (jobText ? ' –≤ ' : '') + person.organization;
                        
                        docChildren.push(new Paragraph({
                            children: [
                                new TextRun({ text: "–î–æ–ª–∂–Ω–æ—Å—Ç—å: ", bold: true }),
                                new TextRun({ text: jobText })
                            ],
                            spacing: { after: 200 }
                        }));
                    }
                    
                    // –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞
                    docChildren.push(new Paragraph({
                        children: [new TextRun({ text: "–ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞:", bold: true, size: 24 })],
                        heading: HeadingLevel.HEADING_3,
                        spacing: { before: 300, after: 200 }
                    }));
                    docChildren.push(new Paragraph({
                        text: person.summary || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.',
                        spacing: { after: 300 }
                    }));

                    // –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
                    if (person.previous_roles && person.previous_roles.length > 0) {
                        docChildren.push(new Paragraph({
                            children: [new TextRun({ text: "–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏:", bold: true, size: 24 })],
                            heading: HeadingLevel.HEADING_3,
                            spacing: { before: 300, after: 200 }
                        }));
                        person.previous_roles.forEach(role => {
                            docChildren.push(new Paragraph({
                                text: `‚Ä¢ ${role}`,
                                bullet: { level: 0 },
                                spacing: { after: 100 }
                            }));
                        });
                    }

                    // –°–≤—è–∑–∏
                    if (person.connections && person.connections.length > 0) {
                        docChildren.push(new Paragraph({
                            children: [new TextRun({ text: "–°–≤—è–∑–∏:", bold: true, size: 24 })],
                            heading: HeadingLevel.HEADING_3,
                            spacing: { before: 300, after: 200 }
                        }));
                        person.connections.forEach(conn => {
                            docChildren.push(new Paragraph({
                                text: `‚Ä¢ ${conn}`,
                                bullet: { level: 0 },
                                spacing: { after: 100 }
                            }));
                        });
                    }

                    // –ò—Å—Ç–æ—á–Ω–∏–∫–∏
                    if (person.sources && person.sources.length > 0) {
                        docChildren.push(new Paragraph({
                            children: [new TextRun({ text: "–ò—Å—Ç–æ—á–Ω–∏–∫–∏:", bold: true, size: 24 })],
                            heading: HeadingLevel.HEADING_3,
                            spacing: { before: 300, after: 200 }
                        }));
                        person.sources.forEach(src => {
                            docChildren.push(new Paragraph({
                                text: `‚Ä¢ ${src.type}: ${src.url}`,
                                bullet: { level: 0 },
                                spacing: { after: 100 }
                            }));
                        });
                    }
                    
                    // –î–æ–∫—É–º–µ–Ω—Ç—ã
                    if (person.documents && person.documents.length > 0) {
                        docChildren.push(new Paragraph({
                            children: [new TextRun({ text: "–î–æ–∫—É–º–µ–Ω—Ç—ã:", bold: true, size: 24 })],
                            heading: HeadingLevel.HEADING_3,
                            spacing: { before: 300, after: 200 }
                        }));
                        person.documents.forEach(doc => {
                            docChildren.push(new Paragraph({
                                text: `‚Ä¢ ${doc.title || '–î–æ–∫—É–º–µ–Ω—Ç'}: ${doc.url}`,
                                bullet: { level: 0 },
                                spacing: { after: 100 }
                            }));
                        });
                    }

                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                    if (person.additional_info) {
                        docChildren.push(new Paragraph({
                            children: [new TextRun({ text: "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:", bold: true, size: 24 })],
                            heading: HeadingLevel.HEADING_3,
                            spacing: { before: 300, after: 200 }
                        }));
                        docChildren.push(new Paragraph({
                            text: person.additional_info,
                            spacing: { after: 300 }
                        }));
                    }

                    // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –ø–µ—Ä—Å–æ–Ω–∞–º–∏ (–∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π)
                    if (index < results.length - 1) {
                        docChildren.push(new Paragraph({
                            children: [new TextRun({ text: "‚Äï".repeat(50), color: "AAAAAA" })],
                            alignment: "center",
                            spacing: { before: 400, after: 400 }
                        }));
                    }
                });

                const doc = new Document({
                    sections: [{ 
                        properties: {},
                        children: docChildren 
                    }]
                });

                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                Packer.toBlob(doc).then(blob => {
                    saveAs(blob, `OSINT_Report_${query.replace(/ /g, '_')}.docx`);
                }).catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Word –¥–æ–∫—É–º–µ–Ω—Ç–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Word –¥–æ–∫—É–º–µ–Ω—Ç–∞: ' + error.message);
                });

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤ generateWord:', error);
                alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Word: ' + error.message);
            }
        }
    });
</script>
</body>
</html>
